

[root@edwardsmarkf comboboxPlay]# clear
[root@edwardsmarkf comboboxPlay]# cat  phoneticTranscriptionGrid.html
<html>

<head>

<link rel="stylesheet" type="text/css" href="/js/smartHtmlElements/9.1.0/source/styles/smart.default.css" />

<style>



html, body {
        margin                  : 40px                                  ;
        padding                 : 10px                                  ;
}

smart-combo-box {
        width                   : 80px                                  ;
}

.tooltipWrapperClass {
        display                 : grid                                  ;
        grid-template-columns   : repeat(4, 25px)                       ;
        grid-gap                : 2px                                   ;
        background-color        : #fff                                  ;
        color                   : #444                                  ;
}

.tooltipElement {
        background-color        : #444                                  ;
        color                   : #fff                                  ;
        border-radius           : 5px                                   ;
        padding                 : 5px                                   ;
        font-size               : 140%                                  ;
}



.wrapper {
        color                   : #444                                  ;
        display                 : grid                                  ;
        max-width               : 1000px                                ;
        grid-gap                : 10px                                  ;
        grid-template-columns   : 100px 200px 150px 120px               ;
        background-color        : #fff                                  ;
}

.box {
        background-color        : #444                                  ;
        color                   : #fff                                  ;
        border-radius           : 5px                                   ;
        padding                 : 20px                                  ;
        font-size               : 150%                                  ;
        display                 : flex                                  ;
        justify-content         : center                                ;
        align-content           : center                                ;
        flex-direction          : column                                ;
                                        /*center alignment */
                                /*     https://stackoverflow.com/questions/9249359/vertically-align-text-within-a-div
                                https://stackoverflow.com/questions/2939914/how-do-i-vertically-align-text-in-a-div/13515693#13515693*/
}

smart-list-item.dropDownOptions {
        border                  : 1px dotted black                      ;
}

smart-list-item.replicationValue        {
        opacity                 : 50%                                   ;
}

smart-list-item.languageNormsError      {
        background-color        : #333                                  ;
}


.tooltipWrapperClass {
  display: grid;
  grid-template-columns:
         repeat(4, 25px);
  grid-gap: 2px;
  background-color: #fff;
  color: #444;
}

.tooltipElement {
  background-color: #444;
  color:  #fff;
  border-radius: 5px;
  padding: 5px;
  font-size: 140%;
}

</style>


    <!-- scripts -->
<script type='module' src='/js/smartHtmlElements/9.1.0/source/modules/smart.combobox.js'></script>
<script type='module' src='/js/smartHtmlElements/9.1.0/source/modules/smart.tooltip.js'></script>

<script>

'use strict;'

const   maxCharsInPhoneticError         = 4     ;

function valueChanged(thisValue) {
        let thisId                      = thisValue.getAttribute('id')                                  ;
        let stimwordPositionAutoIncr    = thisValue.getAttribute('data-stimwordPositionAutoIncr')       ;
        let thisValueOf                 = document.getElementById(thisId).value                         ;
        console.log(thisId + ' -- ' +  stimwordPositionAutoIncr + ' -- ' +  thisValueOf);
}

function replicationValueClicked(thisValue) {
        let clientContextErrorId = thisValue.getAttribute('data-lastDataItemAdded');
        document.getElementById(clientContextErrorId).value = thisValue.textContent;
}



function processItem() {

        const   stimwordWord                    =       'stimwordWord'                  ;               // these names are used so often
        const   contextPositionSoundPhoneme     =       'contextPositionSoundPhoneme'   ;               // that they deserve their own const

        var lastDataItemAdded   =       null    ;               // save this for replication values
        var controlBreak        =       {}      ;               // stores all the control breaks, really just an image of the current record
        var cssVarHolderObj     =       []      ;               // stores all the 'span rules'
        var rowCount            =       0       ;

        for ( let recordNbr in Object.keys(data) )      {
                let record = data[recordNbr] ;
                let incrRowFlag = false;





                for ( let columnNbr in Object.keys(data[recordNbr]) ) {

                        let columnName = Object.keys(data[recordNbr])[columnNbr];

                        switch ( columnName )   {
                            case stimwordWord                   :
                            case contextPositionSoundPhoneme    :
                            case 'stimwordPositionSetting'      :
                            case 'clientContextError'           :
                                if  (   ( record[columnName] != controlBreak[columnName] ))
                                {
                                        controlBreak[columnName] = record[columnName] ;
                                        for ( let xx = parseInt(columnNbr) + 1 ; xx < Object.keys(data[recordNbr]).length; xx++ )
                                                        // null out all subsequent control-break columns !!
                                        {       controlBreak[ Object.keys(data[recordNbr])[xx]  ] = null;  ;
                                        }

                                        let tag = document.createElement("div");
                                        let element             = null  ;
                                        let colStartValue       = null  ;
                                        switch ( columnName )   {

                                                case stimwordWord                       :
                                                        element         =       document.createTextNode(record[columnName])     ;
                                                        colStartValue   =       '1'                                             ;
                                                        break;

                                                case contextPositionSoundPhoneme        :

                                                        colStartValue           = '2'                                                   ;

                                                        let cssVarName          =       '--' + contextPositionSoundPhoneme + '--' + (rowCount + 1).toString()   ;
                                                        cssVarHolderObj.push    (       {       'cssVarName'            :       cssVarName
                                                                                        ,       'startingRowNbr'        :       rowCount
                                                                                        ,       'endingRowNbr'          :       rowCount
                                                                                        }
                                                                                );
                                                        element                 = document.createElement('span')                        ;
                                                        element.innerHTML       = record[columnName]                                    ;
                                                        element.style.setProperty('background' , record['stimwordBackgroundColor'] )    ;
                                                        break;

                                                case 'stimwordPositionSetting'          :

                                                        colStartValue           =       '3'                                                     ;
                                                        element                 =       document.createElement('span')                          ;
                                                        element.innerHTML       =       record[columnName]                                      ;
                                                        element.style.setProperty('background' , record['stimwordBackgroundColor'] )            ;
                                                        break;

                                                case 'clientContextError'               :
                                                        colStartValue                   =       '4'                                             ;
                                                        let elementId                   =       columnName + '-' + rowCount                     ;
                                                        let { stimwordPositionAutoIncr } = record       ;
                                                        lastDataItemAdded               =       elementId                                       ;
                                                        element                         =       document.createElement('smart-combo-box')       ;
                                                        element.style.setProperty('background' , record['stimwordBackgroundColor'] )            ;
                                                        element.setAttribute('value'    , record[columnName]                    );
                                                        element.setAttribute('id'       , elementId                             );
                                                        element.setAttribute('onChange' , 'valueChanged(this);'                 );
                                                        element.setAttribute('data-stimword-position-auto-incr', stimwordPositionAutoIncr)      ;
                                                        break;
                                        } // end switch

                                        if  ( element && colStartValue )        {
                                                tag.appendChild(element);

                                                tag.classList.add('box');

                                                tag.style.gridColumnStart       =       colStartValue   ;
                                                tag.style.gridRowStart          =       (parseInt(rowCount) + 1 ).toString()    ;
                                                tag.style.gridColumnEnd         =       'span 1'        ;

                                                switch ( columnName )   {
                                                        case    stimwordWord                    :
                                                                tag.style.gridRowEnd            =       'span var(--' + stimwordWord + ')'                      ;
                                                                break;
                                                        case    contextPositionSoundPhoneme     :

                                                                let cssVarName  =       '--' + contextPositionSoundPhoneme + '--' + (rowCount + 1).toString()   ;
                                                                tag.style.gridRowEnd            =       'span var(' + cssVarName + ')'                          ;
                                                                break;
                                                        default                                 :
                                                                tag.style.gridRowEnd            =       'span 1'                                                ;
                                                }

                                                document.getElementById('phoneticTranscriptionInputScreen').appendChild(tag);
                                                incrRowFlag = true;
                                        } else {
                                                console.log(`Skipping ${columnName} column in grid!`);
                                        }

                                } else {
                                                // control break triggered
                                        if      (       ( columnName                                    == contextPositionSoundPhoneme                  )
                                                &&      ( record['stimwordPositionSetting']             != controlBreak['stimwordPositionSetting']      )
                                                )
                                        {
                                                        cssVarHolderObj[(cssVarHolderObj.length -1)].endingRowNbr++
                                        }

                                }
                                break;

                            case 'replicationValue'     :

                                if  ( record[columnName] )      {               // make SURE this is not a blank
                                        let nbrOfComboBoxes     =  document.getElementsByTagName('smart-combo-box').length              ;
                                        let tmpComboBox         = document.getElementsByTagName('smart-combo-box')[nbrOfComboBoxes - 1] ;  // get the most recent one
                                        tmpComboBox.insert(99, record[columnName])                              ;
                                        let location            = tmpComboBox.getElementsByTagName('smart-list-item').length -1 ;
                                        let tmpListItem         = tmpComboBox.getElementsByTagName('smart-list-item')[location] ;
                                        tmpListItem.classList.add('dropDownOptions', 'replicationValue' )                       ;
                                        tmpListItem.title       = 'Prior Error'
                                }
                                break;

                            case 'languageNormsError'           :
                                if  ( record[columnName] )      {               // make SURE this is not a blank
                                        let nbrOfComboBoxes     =  document.getElementsByTagName('smart-combo-box').length              ;
                                        let tmpComboBox         = document.getElementsByTagName('smart-combo-box')[nbrOfComboBoxes - 1] ;  // get the most recent one
                                        tmpComboBox.insert(99, record[columnName])                              ;
                                        let location            = tmpComboBox.getElementsByTagName('smart-list-item').length -1 ;
                                        let tmpListItem         = tmpComboBox.getElementsByTagName('smart-list-item')[location] ;
                                        tmpListItem.classList.add('dropDownOptions', 'languageNormsError'       )                       ;
                                        tmpListItem.title       = 'Indian Pakistan'
                                }
                                break;

                        } // end switch statement
                } // end for each column item
                if  ( incrRowFlag )     {
                        rowCount++      ;
                }
        } // end for each record

        //      create the new rule string to "extend" the grid rows since there is not way to automate this (weird) !
        let ruleString = ':root ' + String.fromCharCode(123) + ' --' + stimwordWord + ': ' + rowCount.toString() + ';'  ;       //  using "String.fromCharCode(123)" instead of opening curly-brace for vim!
        for ( let incr in cssVarHolderObj )
        {       let { startingRowNbr, endingRowNbr, cssVarName } = cssVarHolderObj[incr]        ;
                if  ( startingRowNbr != endingRowNbr )
                {   //ruleString += (' ' + cssVarName + ': ' + (startingRowNbr + ( endingRowNbr - startingRowNbr ) + 2 ).toString() + ';' ) ;
                   ruleString += (' ' + cssVarName + ': ' + (( endingRowNbr - startingRowNbr ) + 1 ).toString() + ';' ) ;
                }
        }
        ruleString += String.fromCharCode(125);         // close curly-brace, again so as to not "confuse" vim!
                                        // example:  ruleString = ':root { --stimwordWord--1: 6; --contextPositionSoundPhoneme--1: 2; --contextPositionSoundPhoneme--3: 2; --contextPositionSoundPhoneme--5: 2;}' ;
        document.styleSheets[0].insertRule(ruleString);






    const myTooltip = document.getElementById('myTooltip') ;

    Object.keys(document.getElementsByTagName("smart-combo-box")).forEach((key) => {

       const comboBoxElement = document.getElementsByTagName('smart-combo-box')[key];

       comboBoxElement.querySelector('input').setAttribute('maxlength', maxCharsInPhoneticError);

       comboBoxElement.addEventListener
          ('mouseover', (event) => {
              if   ( event.target.tagName == 'INPUT' )  {
                   comboBoxElement.close();
                   myTooltip.selector = comboBoxElement;
                   comboBoxElement.dataset.oldValue = comboBoxElement.value;   // save old for future testing!!
                   myTooltip.open();
              }
          });

       comboBoxElement.addEventListener
           ('mouseout', event => {
                             // did the cursor leave this combobox by going DOWN or left/right/up ???
               if  ( event.clientY <  comboBoxElement.getBoundingClientRect().bottom - 2 )      // two is the "fugde factor"  !!
               {
                   myTooltip.close();  // close this tooltip ONLY if the cursor went left/right/up otherwise leave open
               }
           });

       comboBoxElement.addEventListener
           ('opening', () => {
                  myTooltip.close();
           });

       comboBoxElement.addEventListener
           ('change', event => {  //debugger;
                if  (!( myTooltip.visible )) {   // ie its CLOSED and therefore not visible
                    processValues ( event.currentTarget.dataset.idNbr
                                  , event.currentTarget.dataset.oldValue
                                  , event.currentTarget.value
                                  );
                    event.currentTarget.dataset.oldValue = event.currentTarget.value;
                } else {
                    console.log('Skipping processing because tooltip is still visible, mouseout will trigger closing the tooltip!')
                }
          });
    });

    myTooltip.addEventListener('mouseleave', (event) =>  {
        myTooltip.close();
        let thisSmartComboBox = document.getElementById(myTooltip.selector.id);
        processValues   ( thisSmartComboBox.dataset.idNbr
                        , thisSmartComboBox.dataset.oldValue
                        , thisSmartComboBox.value
                        );
        thisSmartComboBox.dataset.oldValue = thisSmartComboBox.value // saved for future testing
    })

   const tooltipGridItems = document.getElementById('tooltipGrid').getElementsByTagName('DIV');
   Object.keys(tooltipGridItems).forEach( element =>  {
       let thisDiv = tooltipGridItems[element];
       thisDiv.classList.add('tooltipElement');
       thisDiv.style.cursor = "pointer";
       thisDiv.addEventListener('click', event => {
            let clickedValue = event.target.innerHTML;
            let myComboBox = document.getElementById(myTooltip.selector.id);
            if  ( clickedValue != '&nbsp;' )  {
                if ( myComboBox.value.length < maxCharsInPhoneticError ) {
                    myComboBox.value += clickedValue;
                } else {
                    console.log(`You filled up the phonetic errors input box, max size is ${maxCharsInPhoneticError} characters!`)
                }
            } else {  // delete selected, so remove character on the far right side
                myComboBox.value = myComboBox.value.slice(0, -1)  ;
            }
       });
   }); // end Object.keys(descenands).foreach()






}


function  processValues(id, oldValue, newValue)  {
     console.log('RESULT!! ' + id, 'oldValue:',  (oldValue ? oldValue : 'not yet defined!') , 'newValue: ' , newValue);
}


const data =
[{"stimwordWord": "horse", "contextPositionSoundPhoneme": "initial -- h", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#d3d3d3", "clientContextError": "", "replicationValue": "ø", "languageNormsError": "ø"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "initial -- h", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#d3d3d3", "clientContextError": "", "replicationValue": "", "languageNormsError": "ø"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "aɚ"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "oR"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "oǝ"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "ǝR"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "ǝɚ"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "aɚ"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "oR"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "oǝ"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "ǝR"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "diphthong -- oɚ", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#e0e0e0", "clientContextError": "", "replicationValue": "", "languageNormsError": "ǝɚ"}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "final -- s", "stimwordPositionSetting": "word", "stimwordBackgroundColor": "#d3d3d3", "clientContextError": "", "replicationValue": "", "languageNormsError": ""}
,{"stimwordWord": "horse", "contextPositionSoundPhoneme": "final -- s", "stimwordPositionSetting": "sentence", "stimwordBackgroundColor": "#d3d3d3", "clientContextError": "", "replicationValue": "", "languageNormsError": ""
}];

/*
[ { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Initial - h'    , stimwordPositionSetting:'Word'        , clientContextError: '0'       , stimwordPositionAutoIncr: 123123      , replicationValue : 'XYZ'      , languageSpec : 'A00'  }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Initial - h'    , stimwordPositionSetting:'Word'        , clientContextError: '0'       , stimwordPositionAutoIncr: 123123      , replicationValue : 'ZEF'      , languageSpec : ''     }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Initial - h'    , stimwordPositionSetting:'Word'        , clientContextError: '0'       , stimwordPositionAutoIncr: 123123      , replicationValue : 'WWW'      , languageSpec : 'A01'  }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Initial - h'    , stimwordPositionSetting:'Sentence'    , clientContextError: ''        , stimwordPositionAutoIncr: 123124      , replicationValue : 'ABC'      , languageSpec : 'A02'  }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Diphthong - oe' , stimwordPositionSetting:'Word'        , clientContextError: ''        , stimwordPositionAutoIncr: 123125      , replicationValue : 'DEF'      , languageSpec : 'A03'  }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Diphthong - oe' , stimwordPositionSetting:'Sentence'    , clientContextError: ''        , stimwordPositionAutoIncr: 123126      , replicationValue : 'GHI'      , languageSpec : 'A04'  }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Final - S'      , stimwordPositionSetting:'Word'        , clientContextError: ''        , stimwordPositionAutoIncr: 123127      , replicationValue : 'JKL'      , languageSpec : 'A05'  }
, { stimwordWord: 'Horse', contextPositionSoundPhoneme:'Final - S'      , stimwordPositionSetting:'Sentence'    , clientContextError: ''        , stimwordPositionAutoIncr: 123128      , replicationValue : 'MNO'      , languageSpec : 'A06'  }
]
**/

</script>

</head>

<body>

<div id='phoneticTranscriptionInputScreen' class="wrapper"></div>
<br />
<button onClick="javascript: processItem();">Add Rows!!!</button>


<smart-tooltip id="myTooltip" style='border: 1px dotted red;' open-mode='manual' position='bottom' arrow>
  <div class='tooltipWrapperClass' id='tooltipGrid'>
        <!-- row one  -->
        <div>&nbsp;</div>
        <div>∅</div>
        <div>æ</div>
        <div>ɜ</div>
        <!-- row two -->
        <div>ɚ</div>
        <div>ʌ</div>
        <div>ɔ</div>
        <div>ɝ</div>
        <!-- row three -->
        <div>ʡ</div>
        <div>═</div>
        <div>←</div>
        <div>ǝ</div>
        <!--  row four -->
        <div>Ɒ</div>
        <div>ɛ</div>
        <div>ʃ</div>
        <div>ð</div>
        <!--  row five -->
        <div>ŋ</div>
        <div>θ</div>
        <div>ʀ</div>
        <div>ṭ</div>
        <!--  row six -->
        <div>ʊ</div>
        <div>χ</div>
        <div>ʒ</div>
        <div>ɪ</div>

    </div>

</smart-tooltip>

</body>
</html>
[root@edwardsmarkf comboboxPlay]#
